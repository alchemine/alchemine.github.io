---
title: PostgreSQL Notes
tags: Database
---

# Remarks
본 글은 [Learn PostgreSQL Tutorial - Full Course for Beginners (freeCodeCamp.org)](https://youtu.be/qw--VYLpxG4?si=_ePF2WRyxboaWAIJ)을 참고하여 작성되었습니다.

<!--more-->
---


# 1. Install
## 1.1 Docker
```
$ docker pull
$ docker run -d -p 5432:5432 -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD="1234" --name postgres postgres -v /workspace:/workspace
```


# 2. Run
```
$ docker exec --user='root' -it postgres bash
```


# 3. Connect to database
```
$ su - postgres
$ psql
$ psql test  # connect to 'test' database
```


# 4. DDL
## Notations
```
$: command in bash shell
#: command in postgres shell
CAPITAL: reserved words
```

## Create database
```
CREATE DATABASE test;
```

## Remove database
```
DROP DATABASE test;
```

## List databases
```
$ psql -l
# \l
```

## Connect to another database
```
# \c test
```

## Create table
```
CREATE TABLE table_name (
  column name + data type + constraints if any
)
```

```
CREATE TABLE person (
  id int,
  first_name VARCHAR(50),
  last_name VARCHAR(50),
  gender VARCHAR(7),
  date_of_birth DATE
);

CREATE TABLE person (
  id BIGSERIAL NOT NULL PRIMARY KEY,  /* BIGSERIAL: autoincrementing 8 bytes integer */
  first_name VARCHAR(50) NOT NULL,
  last_name VARCHAR(50) NOT NULL,
  gender VARCHAR(7) NOT NULL,
  date_of_birth DATE NOT NULL,
  email VARCHAR(150)
);
```

## Delete table
```
# DROP TABLE test;
```

## List tables
```
# \d   /* with sequence */
# \dt  /* without sequence */
```

## Describe table
```
# \d person
```

## Alter constraints
```
test=# \d person
                                        Table "public.person"
      Column      |         Type          | Collation | Nullable |              Default
------------------+-----------------------+-----------+----------+------------------------------------
 id               | bigint                |           | not null | nextval('person_id_seq'::regclass)
Indexes:
    "person_pkey" PRIMARY KEY, btree (id)

test=# ALTER TABLE person DROP CONSTRAINT person_pkey;
ALTER TABLE

test=# \d person
                                        Table "public.person"
      Column      |         Type          | Collation | Nullable |              Default
------------------+-----------------------+-----------+----------+------------------------------------
 id               | bigint                |           | not null | nextval('person_id_seq'::regclass)
```

## Primary key
```
CREATE TABLE person (
  id BIGSERIAL NOT NULL PRIMARY KEY
```

## Insert into table
```
INSERT INTO person (
  first_name,
  last_name,
  gender,
  date_of_birth)
VALUES ('Anne', 'Smith', 'FEMALE', DATE '1988-01-09');

INSERT INTO person (
  first_name,
  last_name,
  gender,
  date_of_birth,
  email)
VALUES ('Jake', 'Jones', 'MALE', DATE '1990-01-10', 'jake@gmail.com');
```

## Data generator (mockaroo)
[mockaroo.com](mockaroo.com)

## Execute SQL from file
```
# \i /workspace/sql/person.sql
```


# 5. DML
기본적으로는 [MySQL query](https://alchemine.github.io/2023/07/13/mysql-notes.html)와 유사하므로, MySQL과 비교하여 주요한 특이점을 기술한다.

## LIMIT, OFFSET, FETCH
```
SELECT * FROM table LIMIT 5;  /* ID: [1, 5] */
SELECT * FROM table FETCH FIRST 5 ROWS ONLY;  /* ID: [1, 5] */
SELECT * FROM table OFFSET 5 LIMIT 5;  /* ID: [6, 10] */
```

## LIKE
동일하게 wildcard (`%, _`) 사용가능

## COUNT
```
COUNT(*)  : number of input rows
COUNT(exp): number of input rows which the value of exp IS NOT NULL
```

## COALESCE
Arguments를 받아 not null 값으로 채움
- MySQL의 IFNULL과 같이 사용할 수 있음 (Oracle: NVL)
```
SELECT COALESCE(1) as number;           -- 1
SELECT COALESCE(1, 2) as number;        -- 1
SELECT COALESCE(NULL, 2, 1) as number;  -- 2
SELECT COALESCE(email, 'Email not provided');
```

## NULLIF
```
SELECT NULLIF(a, b);  -- NULL if a == b else a

SELECT 10 / 0;     -- ERROR: division by zero
SELECT 10 / NULL;  -- SUCCESS: NULL
SELECT 10 / NULLIF(2, 5);  -- SUCCESS: 10/2 -> 5

SELECT COALESCE(10 / NULLIF(num, 0), 0);  -- how to handle division by zero
```

## DATE
- Docs: [https://www.postgresql.org/docs/current/datatype-datetime.html](https://www.postgresql.org/docs/current/datatype-datetime.html)

### NOW()
```
test=# SELECT NOW();
              now
-------------------------------
 2023-10-11 09:40:23.326007+00
(1 row)
```

```
test=# SELECT NOW()::DATE;
    now
------------
 2023-10-11
(1 row)
```

```
test=# SELECT NOW()::TIME;
      now
----------------
 09:42:04.97737
(1 row)
```

### INTERVAL
```
test=# SELECT NOW() - INTERVAL '10 YEARS';
           ?column?
-------------------------------
 2013-10-11 09:45:41.177401+00
(1 row)

test=# SELECT NOW() - INTERVAL '10 MONTHS';
           ?column?
-------------------------------
 2022-12-11 09:46:03.224482+00
(1 row)

test=# SELECT NOW() - INTERVAL '10 DAYS';
           ?column?
-------------------------------
 2023-10-01 09:46:09.939125+00
(1 row)

test=# SELECT (NOW()::DATE + INTERVAL '10 MONTHS')::DATE;
    date
------------
 2024-08-11
(1 row)
```

### Extract fields
- [https://www.postgresql.org/docs/16/functions-datetime.html#FUNCTIONS-DATETIME-EXTRACT](https://www.postgresql.org/docs/16/functions-datetime.html#FUNCTIONS-DATETIME-EXTRACT)
```
test=# SELECT EXTRACT(YEAR FROM NOW());
 extract
---------
    2023
(1 row)

test=# SELECT EXTRACT(MONTH FROM NOW());
 extract
---------
      10
(1 row)

test=# SELECT EXTRACT(DAY FROM NOW());
 extract
---------
      11
(1 row)

test=# SELECT EXTRACT(HOUR FROM NOW());
 extract
---------
       9
(1 row)

test=# SELECT EXTRACT(MINUTE FROM NOW());
 extract
---------
      49
(1 row)

test=# SELECT EXTRACT(SECOND FROM NOW());
 extract
----------
 9.058259
(1 row)

test=# SELECT EXTRACT(DOW FROM NOW());  -- 0(Sunday) to 6(Saturday)
 extract
---------
       3
(1 row)

test=# SELECT EXTRACT(CENTURY FROM NOW());
 extract
---------
      21
(1 row)
```

## Age
```
test=# SELECT first_name, date_of_birth, AGE(NOW(), date_of_birth) age FROM person;
   first_name   | date_of_birth |              age
----------------+---------------+--------------------------------
 Marina         | 2023-09-03    | 1 mon 8 days 09:59:09.89202
 Flori          | 2023-03-02    | 7 mons 9 days 09:59:09.89202
 Hildy          | 2023-07-27    | 2 mons 15 days 09:59:09.89202
 ```
---
title: Poetry
tags: Python
---

<!--more-->

여태껏 의존성 관리, 패키징을 하기 위해 `setuptools`를 사용해왔는데 언제부턴가 `poetry(pyproject.toml)` 가 종종 보이더니 이젠 poetry가 대세인 것 같은 모양새가 되었다.

> **[Poetry](https://python-poetry.org/docs)** \
> Poetry is a tool for dependency management and packaging in Python. It allows you to declare the libraries your project depends on and it will manage (install/update) them for you. Poetry offers a lockfile to ensure repeatable installs, and can build your project for distribution.

Poetry의 사용법에 대해 간단하게 알아보자.


# 1. Installation
Official site: [https://python-poetry.org/docs#installation](https://python-poetry.org/docs#installation)

개발환경: `Linux(Rocky Linux 8.6)`, `Ubuntu 22.04`

## 1.1 Install Poetry
Installed directory: `~/.local/share/pypoetry`

```bash
$ curl -sSL https://install.python-poetry.org | python3 -
```

## 1.2 Add Poetry to your PATH
```bash
$ echo 'export PATH=$HOME/.local/bin:$PATH' >> ~/.bashrc
```

## 1.3 Uninstall
```bash
$ curl -sSL https://install.python-poetry.org | python3 - --uninstall
```


# 2. Use Poetry
## 2.1 Update Poetry
```bash
$ poetry --version
$ poetry self update
```

## 2.2 Enable tab completion for Bash, Fish, or Zsh
왜인지 poetry가 shell completion을 지원해준다.

```bash
$ poetry completions bash >> ~/.bash_completion
```

## 2.3 Project setup
### 2.3.1 Initializing
```bash
$ poetry new poetry-demo
```

```bash
poetry-demo
├── pyproject.toml
├── README.md
├── poetry_demo
│   └── __init__.py
└── tests
    └── __init__.py
```

```bash
$ cd pre-existing-project
$ poetry init
```

### 2.3.2 Specifying dependencies
Dependency를 알려주는 `pyproject.toml` 의 기본구성은 다음과 같다. \
각 항목에 대한 자세한 내용은 [여기로](https://python-poetry.org/docs/pyproject/).

```bash
[tool.poetry]
name = "poetry-demo"
version = "0.1.0"
description = ""
authors = ["Your Name <you@example.com>"]
readme = "README.md"
packages = [{include = "poetry_demo"}]

[tool.poetry.dependencies]
python = "^3.10"


[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"
```

`[tool.poetry.dependencies]` 에 package dependency를 추가할 수 있다.

이를 위해 2가지 방법을 소개하고 있는데,

1. 직접 `pyproject.toml` 수정 \
패키지명과 버전을 형식에 맞춰 적어준다.
    ```bash
    # pyproject.toml

    [tool.poetry.dependencies]
    python = "^3.10"
    numpy = "^1.24.2"
    ```

2. `poetry add` \
다음과 같은 명령어는 두 가지 작업을 수행한다.

    ```bash
    $ poetry add numpy
    ```

    1. 적합한 패키지 버전을 찾아 설치 혹은 업데이트
    2. `pyproject.toml`에 해당 패키지의 버전을 추가

버전을 지정하는데 caret/tilde/wildcard/inequality/exact requirements 등을 사용할 수 있다. \
이와 관련된 몇 가지 예시를 살펴보자. 자세한 내용은 [여기로](https://python-poetry.org/docs/dependency-specification/).

1. Caret requirements \
가장 왼쪽의 non-zero digit을 수정하지 않는 버전을 허용
    ```bash
    REQUIREMENT	    VERSIONS ALLOWED
    ^1.2.3	        >=1.2.3  <2.0.0
    ^1.2	        >=1.2.0  <2.0.0
    ^1	            >=1.0.0  <2.0.0
    ^0.2.3	        >=0.2.3  <0.3.0
    ^0.0.3	        >=0.0.3  <0.0.4
    ^0.0	        >=0.0.0  <0.1.0
    ^0	            >=0.0.0  <1.0.0
    ```
2. Tilde requirements \
    major.minor.patch 혹은 major.minor 형식으로 지정한 경우, patch 변화만 허용 \
    major 형식으로 지정한 경우, minor.patch 변화만 허용

    ```bash
    REQUIREMENT	    VERSIONS ALLOWED
    ~1.2.3	        >=1.2.3  <1.3.0
    ~1.2	        >=1.2.0  <1.3.0
    ~1	            >=1.0.0  <2.0.0
    ```
3. Wildcard requirements \
`*` 를 사용한다.
    ```bash
    REQUIREMENT	    VERSIONS ALLOWED
    *	            >=0.0.0
    1.*	            >=1.0.0 <2.0.0
    1.2.*	        >=1.2.0 <1.3.0
    ```
4. Inequality requirements
    ```bash
    >= 1.2.0
    > 1
    < 2
    != 1.2.3
    ```
5. Multiple requirements
    ```bash
    >= 1.2, < 1.5
    ```
6. Exact requirements \
    `==` 를 이용하나, 사실 생략해도 무방하다.
    ```bash
    1.2.3
    ==1.2.3
    ```

## 2.4 Installing dependencies
```bash
$ poetry install
```

`pyproject.toml` 에 기록한 종속성들을 위의 명령어로 설치할 수 있다. \
이때, `poetry.lock` 이 존재하는지 여부에 따라 수행되는 작업이 달라진다.

1. `poetry.lock` 이 없는 경우 \
`pyproject.toml` 의 종속성들을 설치하고 `poetry.lock` 에 저장하여 프로젝트를 해당 버전에 `lock` 한다.
    > You should commit the `poetry.lock` file to your project repo so that all people working on the project are locked to the same versions of dependencies.
2. `poetry.lock` 이 있는 경우 \
`pyproject.toml`의 종속성들을 설치하는데 `poetry.lock` 에 저장된 특정 버전으로 설치한다.

### 2.4.1 Commit `poetry.lock` to version control
프로젝트를 공유하는 모든 사람들이 동일한 버전의 종속성들을 사용할 수 있도록 `poetry.lock` 을 commit해야 한다.

## 2.5 Managing environments
종속성 관리와 함께 프로젝트 환경을 분리하는 것도 `poetry`의 핵심 기능이다. \
라고 하지만 이 친구가 직접적으로 뭔가 해주는 것 같진 않다. \
기존과 같이 `pyenv` 를 이용하는 것이 좋아보인다.

```bash
# test.sh

#!/bin/bash

for version in 3.8.16 3.9.16 3.10.10
do
#  pyenv install $version
  pyenv virtualenv $version test-$version
  source ~/.pyenv/versions/test-$version/bin/activate
  poetry install --no-root
  python -m pytest
  pyenv uninstall -f test-$version
done
```

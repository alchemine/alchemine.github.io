---
title: 2. AWS 아키텍처 설계 기본
tags: Study_AWSDataEngineering
---

<!--more-->

# 1. AWS 아키텍팅 하기 전에 알아야 할 것들
## 1) AWS Well-Architecture Framework (5개 pillar)
![Alt text](image.png)

### 1. 운영 우수성
![Alt text](image-1.png)

### 2. 보안
![Alt text](image-2.png)

![Alt text](image-3.png)
- 물리보안: AWS가 담당
- 이외는 고객이 담당

### 3. 안정성 (가장 중요)
![Alt text](image-4.png)

- Immutable 아키텍처를 설계하여 시스템 장애 발생 시 빠르게 복구할 수 있도록 해야 함
- 수평 확장 설계: auto scaling

### 4. 성능 효율성
![Alt text](image-5.png)

### 5. 비용 최적화
![Alt text](image-6.png)


## 2) AWS 서버 인프라의 확장 과정
![Alt text](image-7.png)
- EC2 하나에 application, DB 엔진이 설치되어 있음

![Alt text](image-8.png)
- EC2를 이중화하여 서버의 가용성을 확보
- DB를 RDS에 단일형으로 분리/관리
- DB가 단일화되어 비교적 안정성이 떨어짐

![Alt text](image-9.png)
- RDS의 multi-AZ 기능을 사용하여 DB를 이중화
    - Master DB에 장애가 생겨도 slave DB에서 failover 할 수 있어 DB의 안정성 확보 가능

![Alt text](image-10.png)
- Load balancer(ELB)를 통한 부하분산이 추가된 설계
- ELB를 EC2 앞단에 배치하여 EC2를 외부에서 직접 접근이 불가능
    - Health check, monitoring 기능 사용 가능

![Alt text](image-11.png)
- EC2의 auto scaling 기능을 사용하여 서버의 수평 확장이 가능
- 트래픽 증가 시, EC2 수평 확장으로 인해 DB에 예상치못한 부하가 발생 가능 \
따라서, DB도 부하를 감당할 수 있게 설계할 필요가 있음

![Alt text](image-12.png)
- EC2에 있던 정적 컨텐츠를 S3로 위임
    - EC2의 부하를 줄일 수 있음
    - S3의 다양한 기능을 통해 컨텐츠 접근 관리, 형상 관리 가능

![Alt text](image-13.png)
- 정적 컨텐츠를 빠르게 배포하기 위해 Cloudfront를 활용
- 각 지역에 존재하고 있는 edge location에 S3의 정적 컨텐츠가 캐시되어 서비스의 성능 향상 가능

![Alt text](image-14.png)
- 정적 컨텐츠뿐만 아니라, 모든 트래픽을 Cloudfront로 서비스하는 설계
- 동적 컨텐츠에 대해서도 캐시 기능을 사용

![Alt text](image-15.png)
- 글로벌 인프라 확장


## 3) AWS 리소스 네이밍 컨벤션
1. 리소스 태그
    - VPC, EC2, subnet 등 모든 리소스
    - 상시 변경 가능
2. 리소스 자체
    - ELB, RDS, Elasticache 등
    - 변경 불가 (리소스 재생성)

![Alt text](image-16.png)

![Alt text](image-17.png)


# 2. 네트워크 기초
## 1) 네트워크 CIDR에 대한 설명
**CIDR(Classless Inter-Domain Routing)** \
클래스 없는 도메인간 라우팅 기법
{:.success}

![Alt text](image-18.png)

### 1. CIDR 주소 표기법
![Alt text](image-19.png)

- 사용할 수 있는 IP의 범위를 표시

### 2. CIDR 주소 계산
![Alt text](image-20.png)

- `/26`: Subnet mask `B` (앞에서부터 1의 개수)
- https://www.ipaddressguide.com/cidr
- `$ ipcalc 10.10.1.2/26`


## 2) 네트워크 트래픽과 대역폭
![Alt text](image-21.png)

## 3) HTTP, SSL, TLS 개념
![Alt text](image-22.png)

## 4) 웹브라우저에서 도메인 URL을 입력하면 일어나는 일들
![Alt text](image-23.png)

1. 웹브라우저가 URL을 분석
2. HSTS 목록 확인
    1. HSTS 목록에 존재하면, HTTPS로 보내기
    2. 없으면, HTTP로 보내기
3. 웹브라우저에 캐시되어 있는 도메인인지 확인
    1. 캐시가 되어 있으면 해당 화면 보여주기
    2. 아니면 다음 단계
4. OS 내에 캐시되어 있는 도메인인지 확인
    1. 캐시가 되어 있으면 해당 화면 보여주기
    2. 아니면 다음 단계
5. 로컬 PC의 hosts 설정 확인
    1. 호스트 설정이 되어 있으면, 해당 도메인 보여주기
6. DHCP & ARP의 라우터 확인하여 도메인을 쿼리?
...

## 5) AWS에서 네트워크 설계하기
![Alt text](image-24.png)

![Alt text](image-25.png)

![Alt text](image-26.png)

## 6) NACL과 security group (stateless vs statefull)
![Alt text](image-27.png)


# 3. VPC 실습하기
## 1) 목표 네트워크 아키텍처 설명
![Alt text](image-30.png)

![Alt text](image-29.png)


## 2) VPC 생성하기 (vpc, subnet, routetable)
1. VPC/VPC 생성
    1. IPv4 CIDR: `10.1.0.0/16`
2. VPC/서브넷/서브넷 생성 \
![Alt text](image-32.png)
3. 인터넷 게이트웨이 생성
    1. 이름: `my-igw`
    2. VPC에 연결 (`my-vpc`)
4. 라우팅 테이블/라우팅 테이블 생성
    1. 이름: `my-public-route`
    1. 이름: `my-private-route`
5. NAT 게이트웨이
    1. 이름: `my-natgateway`
    2. 서브넷: `my-public-subnet-a`
    3. 탄력적 IP 할당
6. 라우팅 테이블
    1. `my-public-route`
        1. 라우팅/라우팅 편집
            1. 대상: `0.0.0.0/0`
            2. 대상: `인터넷 게이트웨이` - `igw-...`
        2. 서브넷 연결/서브넷 연결 편집
            1. `my-public-...`
    2. `my-private-route`
        1. 라우팅/라우팅 편집
            1. 대상: `0.0.0.0/0`
            2. 대상: `NAT 게이트웨이` - `nat-...`
        2. 서브넷 연결/서브넷 연결 편집
            1. `my-private-...`

## 3) Bastion host 구성 및 NAT, GW 실습 구성
![Alt text](image-28.png)

1. EC2/보안 그룹/보안 그룹 생성
    1. 이름: `my-bastion-host-sg`
        1. VPC: `my-vpc`
        2. 인바운드 규칙
            1. 유형: SSH
            2. 대상: 내 IP
    2. 이름: `my-private-ec2-sg`
        1. VPC: `my-vpc`
        2. 인바운드 규칙
            1. 유형: SSH
            2. 대상: `my-bastion-host-sg`
2. EC2/인스턴스/인스턴스 시작
    1. 이름: `my-bastion-host`
    2. 키 페어: `my-ec2-keypair`
    3. 네트워크
        1. VPC: `my-vpc`
        2. 서브넷: `my-public-subnet-a`
        3. 기존 보안 그룹 선택: `my-bastion-host-sg`
3. EC2/탄력적 IP
    1. 탄력적 IP 주소 할당
    2. 탄력적 IP 주소 연결
        1. `my-bastion-host`
    3. `my-bastion-host` 퍼블릭 IPv4 주소 확인
4. EC2/인스턴스/인스턴스 시작
    1. 이름: `my-private-ec2`
    2. 키 페어: `my-ec2-keypair`
    3. 네트워크
        1. VPC: `my-vpc`
        2. 서브넷: `my-private-subnet-app-a`
        3. 기존 보안 그룹 선택: `my-private-ec2-sg`


## 4) OpenVPN 구성 및 NAT Gateway 실습
![Alt text](image-33.png)

1. EC2/인스턴스 생성
    1. 이름: `my-openvpn-ec2`
    2. AMI 선택
        1. `openvpn` 검색
        2. `OpenVPN Access Server` 선택
    3. 네트워크
        - `my-vpc`, `my-public-subnet-a`
    4. 보안 그룹 생성
        1. 인바운드 보안 그룹 규칙
            - 소스 유형(전체): `내 IP`
2. `my-private-ec2-sg`
    1. 인바운드 규칙에 `my-openvpn-ec2` SSH 열어두기
3. 탄력적 IP 주소 할당/인스턴스 연결
4. Admin UI 접속
    ```
    Admin  UI: https://43.200.141.126:943/admin
    Client UI: https://43.200.141.126:943/
    ```
5. USER MANAGEMENT/USER Permissions
    1. 유저 추가
        1. Username: `my-private-ec2`
        2. Allow Auto-login
        3. Password 설정
        4. Save settings
6. Client UI 에서 프로그램 설치
7. VPN 연결 후, private 인스턴스에 접속 가능


## 5) VPC Peering 실습
![Alt text](image-34.png)

1. 도쿄 region에서 VPC 생성
    1. 생성할 리소스: VPC 등
    2. 이름 태그 자동 생성: `my-tokyo`
    3. IPv4 CIDR 블록: `192.168.10.0/24` \
    서울 region과 겹치지 않아야함
    4. NAT 게이트웨이, VPC 엔드포인트: 없음
2. 인스턴스 생성
    1. 이름: `my-tokyo-private-ec2`
    2. 키 페어: 키 페어 없이 계속 진행 \
    직접 접근할 것이 아니기 때문에 선택 X
    3. VPC: `my-tokyo-vpc`
    4. 서브넷: `my-tokyo-subnet-private1-ap-northeast-1a`
    5. 인바운드 규칙 편집/추가
        1. 유형: 모든 ICMP - IPv4
        2. 소스: `10.1.0.0/16` (서울 region)
3. VPC/Peering connections
    1. 피어링 연결 생성
        1. 이름: `my-peer-tokyo-to-seoul`
        2. VPC(요청자): `my-tokyo-vpc`
        3. 계정: 내 계정
        4. 리전: 다른 리전
        5. VPC ID(수락자): 서울 region vpc id
    2. 서울 region으로 와서 `요청 수락`
    3. 이름 변경: `my-peer-tokyo-to-seoul`
4. 서울 region/VPC/라우팅 테이블
    1. `my-private-route`/라우팅 편집/라우팅 추가
    2. 대상: `192.168.10.0/24`
    3. 대상: 피어링 연결, `my-peer-tokyo-to-seoul`
    4. 도쿄 region도 마찬가지 step 1-3 수행 (`my-tokyo-rtb-private1-ap-northeast-1a`)
5. 서울 private ec2에서 도쿄 ec2로 ping test \
`ping 192.168.10.142`


# 4. 소규모 서비스 구축해보기
## 1) 목표 아키텍처 및 개발 환경 설명
![Alt text](image-35.png)

## 2) Route53 및 ACM 생성하기
1. Route53/등록된 도메인
    1. 도메인 등록
2. Certificate Manager
    1. 인증서 요청
    2. 완전히 정규화된 도메인 이름
        - `alchemine.link`
        - `*.alchemine.link`
    3. 인증서/Route 53에서 레코드 생성
    4. 인증서 나열에서 `발급됨` 상태 확인

## 3) 보안 그룹 생성하기 (ALB/EC2/RDS)
![Alt text](image-36.png)

